{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/0415-docker-jenkins-gatsby/","result":{"data":{"site":{"siteMetadata":{"title":"なばろぐ","description":"プログラミング、ピアノ作曲・演奏、雑記など"}},"markdownRemark":{"html":"<div class=\"alert info\">\nはてなブログからの移行記事\n</div>\n<p>環境構築で躓く人用と自分のためにメモ。</p>\n<h1 id=\"検証、構築環境\" style=\"position:relative;\"><a href=\"#%E6%A4%9C%E8%A8%BC%E3%80%81%E6%A7%8B%E7%AF%89%E7%92%B0%E5%A2%83\" aria-label=\"検証、構築環境 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>検証、構築環境</h1>\n<ul>\n<li>\n<p>Windows 10 Pro</p>\n<ul>\n<li>Insider Preview 19041.207</li>\n</ul>\n</li>\n<li>\n<p>WSL2</p>\n<ul>\n<li>Ubuntu-18.04</li>\n</ul>\n</li>\n<li>\n<p>Jenkins</p>\n<ul>\n<li>実行当時は 2.222.1</li>\n</ul>\n</li>\n<li>\n<p>node -v</p>\n<ul>\n<li>v12.16.2</li>\n</ul>\n</li>\n<li>\n<p>npm -v</p>\n<ul>\n<li>6.14.4</li>\n</ul>\n</li>\n<li>\n<p>gatsby -v</p>\n<ul>\n<li>Gatsby CLI version: 2.11.8</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"docker-compose-ファイル\" style=\"position:relative;\"><a href=\"#docker-compose-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" aria-label=\"docker compose ファイル permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>docker-compose ファイル</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: &#39;3&#39;\nservices:\n  jenkins:\n    image: jenkins/jenkins:lts\n    volumes:\n      - ./jenkins_home:/var/jenkins_home\n    working_dir: /var/jenkins_home\n    ports:\n      - &quot;8080:8080&quot;\n      - &quot;50000:50000&quot;\n    tty: true</code></pre></div>\n<ul>\n<li>Jenkins イメージは公式の LTS を指定</li>\n<li>コンテナ内において、 <em>/var/jenkins_home</em> を Jenkins のワーキングディレクトリに指定し、データを永続化させるためにローカルの <em>./jenkins_home</em> とボリューム共有化</li>\n<li>ポートは基本 8080 で大丈夫だと思う。50000 番はスレーブ用らしい。</li>\n</ul>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<p><a href=\"https://qiita.com/legitwhiz/items/e6ac1f5a94f09ff2bb1d\">https://qiita.com/legitwhiz/items/e6ac1f5a94f09ff2bb1d</a></p>\n<p><a href=\"https://tsubalog.hatenablog.com/entry/2017/08/12/090000\">https://tsubalog.hatenablog.com/entry/2017/08/12/090000</a></p>\n<h1 id=\"コンテナ起動\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E8%B5%B7%E5%8B%95\" aria-label=\"コンテナ起動 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コンテナ起動</h1>\n<p>コンテナとの共有用のディレクトリ作成</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">WSL $ mkdir jenkins_home</code></pre></div>\n<p>コンテナ起動</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">WSL $ docker-compose up\nコンソールに起動時に入力するパスワードが表示されるので、必ずメモ\n～\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  |\njenkins_1  | Jenkins initial setup is required. An admin user has been created and a password generated.\njenkins_1  | Please use the following password to proceed to installation:\njenkins_1  |\njenkins_1  | XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\njenkins_1  |\njenkins_1  | This may also be found at: /var/jenkins_home/secrets/initialAdminPassword\njenkins_1  |\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\n～</code></pre></div>\n<p>Jenkins のセットアップについては、他を参照。</p>\n<p><a href=\"https://qiita.com/zb185423/items/af2643fa6ebf0639b6ab\">https://qiita.com/zb185423/items/af2643fa6ebf0639b6ab</a></p>\n<h1 id=\"nodejs-インストール\" style=\"position:relative;\"><a href=\"#nodejs-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\" aria-label=\"nodejs インストール permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Node.js インストール</h1>\n<p>コンテナにルートユーザーで入る。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">WSL $ docker-compose exec --user root jenkins /bin/bash</code></pre></div>\n<p>公式のセットアップ方法を利用。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Conaitner # curl -sL https://deb.nodesource.com/setup_12.x | bash -\nContainer # apt-get install -y nodejs</code></pre></div>\n<h2 id=\"参照\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E7%85%A7\" aria-label=\"参照 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参照</h2>\n<p><a href=\"https://github.com/nodesource/distributions/blob/master/README.md\">https://github.com/nodesource/distributions/blob/master/README.md</a></p>\n<h1 id=\"gatsbyjs-インストール\" style=\"position:relative;\"><a href=\"#gatsbyjs-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\" aria-label=\"gatsbyjs インストール permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GatsbyJS インストール</h1>\n<p>一旦コンテナを抜けて、jenkins ユーザーで入り直す</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">WSL $ docker-compose exec jenkins /bin/bash</code></pre></div>\n<p>そのままインストールしようとすると、多分 <em>permission denied</em> エラーが起きるので、インストールパスを <em>~/.npm-global</em> に変更。\nglobal インストールしてるのは許して＞＜</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Container $ mkdir ~/.npm-global\nContainer $ npm config set prefix &#39;~/.npm-global&#39;\nContainer $ vim ~/.profile\n.profile 多分新規作成。下記を追加して保存\nexport PATH=~/.npm-global/bin:$PATH\nContainer $ source ~/.profile\nContainer $ npm install -g gatsby-cli</code></pre></div>\n<h2 id=\"参照-1\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E7%85%A7-1\" aria-label=\"参照 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参照</h2>\n<p><a href=\"https://qiita.com/okohs/items/ced3c3de30af1035242d\">https://qiita.com/okohs/items/ced3c3de30af1035242d</a></p>\n<p>セットアップについてはこれで完了。</p>\n<h1 id=\"gatsbyjs-ビルドについて\" style=\"position:relative;\"><a href=\"#gatsbyjs-%E3%83%93%E3%83%AB%E3%83%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"gatsbyjs ビルドについて permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GatsbyJS ビルドについて</h1>\n<p>ビルド時は、毎回 <em>gatsby clean</em> をしたほうが良いかもしれない。（Jenkins に限らずローカルでも再現した）<br>\n勉強し初めなので理由はまだ分からないが、公式チュートリアルで一旦動くことまで確認してジョブを実行したところ、1回目は成功するが、2回目から <em>ERROR #98123 WEBPACK</em> エラーが起きてしまった。<br>\nキャッシュデータを消さないとうまく行かないらしい？</p>\n<p>サンプルジョブシェル</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#!/bin/bash\n\nsource ~/.profile\n\ncd &quot;GatsbyJS プロジェクトパス&quot;\nnpm install\ngatsby clean\ngatsby build\n\n～これ以降はコミットするなりデプロイするなり～</code></pre></div>\n<ul>\n<li>\n<p>1行目の <em>#!/bin/bash</em> は、source 行を実行するために必要</p>\n<ul>\n<li>デフォルトシェルが sh だから？</li>\n<li><a href=\"https://stackoverflow.com/questions/13702425/source-command-not-found-in-sh-shell/13702876\">https://stackoverflow.com/questions/13702425/source-command-not-found-in-sh-shell/13702876</a></li>\n</ul>\n</li>\n<li>source 行は、先程作成した <em>.profile</em> を指定。そうしないと先程 global でインストールした gatsby コマンドが見当たらない、と言われる</li>\n</ul>\n<h2 id=\"参考-1\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83-1\" aria-label=\"参考 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<p><a href=\"https://github.com/gatsbyjs/gatsby/issues/22755\">https://github.com/gatsbyjs/gatsby/issues/22755</a></p>","tableOfContents":"<ul>\n<li><a href=\"/2020/0415-docker-jenkins-gatsby/#%E6%A4%9C%E8%A8%BC%E3%80%81%E6%A7%8B%E7%AF%89%E7%92%B0%E5%A2%83\">検証、構築環境</a></li>\n<li>\n<p><a href=\"/2020/0415-docker-jenkins-gatsby/#docker-compose-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\">docker-compose ファイル</a></p>\n<ul>\n<li><a href=\"/2020/0415-docker-jenkins-gatsby/#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>\n</li>\n<li><a href=\"/2020/0415-docker-jenkins-gatsby/#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E8%B5%B7%E5%8B%95\">コンテナ起動</a></li>\n<li>\n<p><a href=\"/2020/0415-docker-jenkins-gatsby/#nodejs-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\">Node.js インストール</a></p>\n<ul>\n<li><a href=\"/2020/0415-docker-jenkins-gatsby/#%E5%8F%82%E7%85%A7\">参照</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2020/0415-docker-jenkins-gatsby/#gatsbyjs-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\">GatsbyJS インストール</a></p>\n<ul>\n<li><a href=\"/2020/0415-docker-jenkins-gatsby/#%E5%8F%82%E7%85%A7-1\">参照</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2020/0415-docker-jenkins-gatsby/#gatsbyjs-%E3%83%93%E3%83%AB%E3%83%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\">GatsbyJS ビルドについて</a></p>\n<ul>\n<li><a href=\"/2020/0415-docker-jenkins-gatsby/#%E5%8F%82%E8%80%83-1\">参考</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"Docker + Jenkins で GatsbyJs ビルド環境作成","date":"2020/04/15 23:17","tags":["Docker","Jenkins","GatsbyJS"]},"id":"7126bf62-533a-5995-a1d1-7f1e8791cd55","excerpt":"環境構築で躓く人用と自分のためにメモ。 検証、構築環境 Windows 10 Pro Insider Preview 19041.207 WSL2 Ubuntu-18.04 Jenkins 実行当時は 2.222.1 node -v v12.16.2 npm -v 6.14.…"},"relatedPosts":{"edges":[{"node":{"fields":{"slug":"/2020/0415-docker-jenkins-gatsby/"},"frontmatter":{"title":"Docker + Jenkins で GatsbyJs ビルド環境作成","date":"2020/04/15 23:17","tags":["Docker","Jenkins","GatsbyJS"]},"id":"7126bf62-533a-5995-a1d1-7f1e8791cd55"}},{"node":{"fields":{"slug":"/2020/0415-docker-jenkins-gatsby/"},"frontmatter":{"title":"Docker + Jenkins で GatsbyJs ビルド環境作成","date":"2020/04/15 23:17","tags":["Docker","Jenkins","GatsbyJS"]},"id":"7126bf62-533a-5995-a1d1-7f1e8791cd55"}},{"node":{"fields":{"slug":"/2020/0415-docker-jenkins-gatsby/"},"frontmatter":{"title":"Docker + Jenkins で GatsbyJs ビルド環境作成","date":"2020/04/15 23:17","tags":["Docker","Jenkins","GatsbyJS"]},"id":"7126bf62-533a-5995-a1d1-7f1e8791cd55"}},{"node":{"fields":{"slug":"/2020/0127-docker-react/"},"frontmatter":{"title":"Docker + React 開発環境を整える","date":"2020/01/27 00:22","tags":["Docker","React"]},"id":"11087176-384d-5fb9-9e86-ecc80f1a71ba"}},{"node":{"fields":{"slug":"/2019/1109-selenium/"},"frontmatter":{"title":"Python (Client) + Selenium Server (Docker) で Web スクレイピング環境構築","date":"2019/11/09 12:06","tags":["Python","Selenium","Docker"]},"id":"f13dc642-5d51-5a3b-9c39-af67352ece87"}}]}},"pageContext":{"slug":"/2020/0415-docker-jenkins-gatsby/","tags":["Docker","Jenkins","GatsbyJS"]}}}